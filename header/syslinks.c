/* 
 * =============================================================================
 *                            OS-independent includes
 * =============================================================================
 */

#include "syslinks.h"

#if defined(_WIN32) || defined(_WIN64)

/* 
 * =============================================================================
 *                            Windows: includes
 * =============================================================================
 */

#include <windows.h>
#include <direct.h>
#include <intrin.h>

/* 
 * =============================================================================
 *                            Windows: path separator
 * =============================================================================
 */

uint8_t
path_sep() {
	return '\\';
}

/* 
 * =============================================================================
 *                            Windows: file exists
 * =============================================================================
 */

uint8_t
file_exists(const char* filename) {
    DWORD file_att = GetFileAttributes(filename);
    return file_att != INVALID_FILE_ATTRIBUTES && \
    	   !(file_att & FILE_ATTRIBUTE_DIRECTORY);
}

/* 
 * =============================================================================
 *                            Windows: create directory
 * =============================================================================
 */

uint8_t
create_dir(const char* dirname) {
	return _mkdir(dirname);
}

/* 
 * =============================================================================
 *                            Windows: read time-stamp counter
 * =============================================================================
 */

uint64_t
rdtsc() {
    return _rdtsc();
}

#elif defined(__unix__) || defined(__APPLE__)

/* 
 * =============================================================================
 *                            Unix/Apple: includes
 * =============================================================================
 */

#include <unistd.h>
#include <sys/stat.h>

/* 
 * =============================================================================
 *                            Unix/Apple: path separator
 * =============================================================================
 */

uint8_t
path_sep() {
	return '/';
}

/* 
 * =============================================================================
 *                            Unix/Apple: file exists
 * =============================================================================
 */

uint8_t
file_exists(const char* filename) {
	return !access(filename, F_OK);
}

/* 
 * =============================================================================
 *                            Unix/Apple: create directory
 * =============================================================================
 */

uint8_t
create_dir(const char* dirname) {
	return !mkdir(dirname, 0777);
}

/* 
 * =============================================================================
 *                            Unix/Apple: read time-stamp counter
 * =============================================================================
 */

uint64_t
rdtsc() {
    uint32_t lo, hi;
    __asm__ __volatile__ (
    	"rdtsc" : "=a" (lo), "=d" (hi)
    );
    return ((uint64_t)hi << 32) | lo;
}

#endif